#!/bin/sh
# Enforce 50/72 commit message formatting
# - Subject (first non-comment line) <= 50 chars
# - Blank line after subject
# - Body lines <= 72 chars (trailers allowed)
# Comment lines starting with '#' are ignored.

set -eu

MSG_FILE="$1"

non_comment() {
	sed -e '/^#/d' "$1"
}

first_non_comment_line() {
	non_comment "$1" | sed -n '1p'
}

subject="$(first_non_comment_line "$MSG_FILE")"

# Allow empty messages (e.g., merges) to pass
if [ -z "$subject" ]; then
	exit 0
fi

# Enforce max 50 chars for subject
subject_len=$(printf '%s' "$subject" | wc -m | tr -d ' ')
if [ "$subject_len" -gt 50 ]; then
	echo "ERROR: Commit subject exceeds 50 characters ($subject_len)." 1>&2
	echo "Tip: Keep it short, imperative, and under 50 chars." 1>&2
	exit 1
fi

# If there's a body, require a blank line after subject
rest=$(non_comment "$MSG_FILE" | tail -n +2)
if [ -n "$rest" ]; then
	second_line=$(sed -n '2p' "$MSG_FILE")
	case "$second_line" in
	\#*) : ;; # comment line is fine
	"") : ;;  # blank line OK
	*)
		echo "ERROR: Missing blank line between subject and body." 1>&2
		exit 1
		;;
	esac
fi

# Body line length check (<=72), ignoring common trailers
body=$(printf '%s\n' "$rest")
if [ -n "$body" ]; then
	long_lines=$(printf '%s\n' "$body" | awk "!(\$0 ~ /^(Co-authored-by:|Signed-off-by:|Refs:|Fixes:)/) { if (length(\$0) > 72) print NR }")
	if [ -n "$long_lines" ]; then
		echo "ERROR: One or more body lines exceed 72 characters." 1>&2
		echo "Tip: Wrap commit body at 72 characters per line." 1>&2
		exit 1
	fi
fi

exit 0
